<!DOCTYPE html>
<html>
<head>
	<script src="https://unpkg.com/force-graph"></script>
	<script src="https://unpkg.com/dat.gui"></script>
</head>
<body>
  <div id="graph"></div>

  <script>
	const colors = [
		"#1984c5",
		"#22a7f0",
		"#63bff0",
		"#a7d5ed",
		"#e2e2e2",
		"#e1a692",
		"#de6e56",
		"#e14b31",
		"#c23728",
	]

	const [blue3, blue2, blue1, grey, red1, red2, red3] = colors;

	const Graph = ForceGraph()(document.getElementById('graph'))
		.graphData({nodes:[], links: []})
		.nodeLabel('id')
		.linkLabel("label")
		.linkDirectionalArrowLength(10)
		.linkDirectionalArrowRelPos(1)
		.onNodeDragEnd(node => {
			node.fx = node.x;
			node.fy = node.y;
		});

	function updatePath(path) {
		path = path ? path : [];
		function hasEdge(u, v) {
			const i = path.indexOf(u)
			const j = path.indexOf(v)

			return i != -1 && j != -1 && j == i + 1
		} 
		Graph
			.nodeColor(node => path.includes(node.id) ? red3 : grey)
			.linkWidth(link => hasEdge(link.source.id, link.target.id) ? 2 : 1)
			.linkColor(link => hasEdge(link.source.id, link.target.id) ? red2 : grey)
	}

	fetch('/data')
		.then(res => res.json())
		.then(vis_data => {
			graphs = vis_data.graphs
			solvers = vis_data.solvers

			const gui = new dat.GUI();

			const config = {
				graph_id: graphs[0].graph_id,
				solution: solvers[0],
			};

			const getGraph = (graph_id) => graphs[graphs.findIndex(graph => graph.graph_id === graph_id)];

			gui.add(config, 'graph_id', graphs.map(graph => graph.graph_id))
				.onChange((graph_id) => { Graph.graphData(getGraph(graph_id).data) });
				
			gui.add(config, 'solution', solvers)
				.onChange((solution) => {
					const graph = getGraph(config.graph_id)
					// Assumes unique solution labels
					const solutionIndex = solvers.indexOf(solution);
					const result = graph.results[solutionIndex]
					updatePath(result.path)
				});

			// Load the default graph
			Graph.graphData(graphs[0].data)
			updatePath(graphs[0].results[0].path)
		});
  </script>
</body>
</html>