<!DOCTYPE html>
<html>
<head>
	<script src="https://unpkg.com/force-graph"></script>
	<script src="https://unpkg.com/dat.gui"></script>
</head>
<body>
  <div id="graph"></div>

  <script>
	const colors = [
		"#1984c5",
		"#22a7f0",
		"#63bff0",
		"#a7d5ed",
		"#e2e2e2",
		"#e1a692",
		"#de6e56",
		"#e14b31",
		"#c23728",
	]

	const [blue3, blue2, blue1, grey, red1, red2, red3] = colors;

	// // Function to check if a pair is in the list of edges
	// function edgeInPath(src, tar, edges) {
	// 	const value = edges.some(([i, j]) => src === i && tar === j)
	// 	console.log(value, src, tar, edges)
	// 	return value
	// }

	const Graph = ForceGraph()(document.getElementById('graph'))
		.graphData({nodes:[], links: []})
		.nodeLabel('id')
		.nodeColor(node => node.in_path ? red3 : grey)
		.linkWidth(link => link.in_path ? 2 : 1)
		.linkLabel("label")
		.linkColor(link => link.in_path ? red2 : grey)
		.linkDirectionalArrowLength(10)
		.linkDirectionalArrowRelPos(1)
		.onNodeDragEnd(node => {
			node.fx = node.x;
			node.fy = node.y;
		});

	function updateGraph(graphData, result) {
		const path = result.path ? result.path : [];
		
		const links = graphData.links.map((link) => {
			for (var i = 0; i + 1 < path.length; i++) {
				if (link.source == path[i] && link.target == path[i+1]) {
					return {...link, ...{in_path: true}}
				}
			}
			return {...link, ...{in_path: false}}
		})

		const nodes = graphData.nodes.map((node) => ({...node, ...{in_path: path.includes(node.id)}}))

		Graph.graphData({
			nodes: nodes,
			links: links,
		});
	}

	fetch('/vis_data')
		.then(res => res.json())
		.then(vis_data => {
			graphs = vis_data.graphs
			solvers = vis_data.solvers

			const gui = new dat.GUI();

			const config = {
				graph_id: graphs[0].graph_id,
				solution: solvers[0],
			};

			function update(graph_id, solution) {
				const graphIndex = graphs.findIndex(graph => graph.graph_id === graph_id);
				// Assumes unique solution labels
				const solutionIndex = solvers.indexOf(solution);
				const graph = graphs[graphIndex];
				const result = graph.results[solutionIndex]
				updateGraph(graph.data, result);
			}

			gui.add(config, 'graph_id', graphs.map(graph => graph.graph_id))
				.onChange((graph_id) => update(graph_id, config.solution));

			gui.add(config, 'solution', solvers)
				.onChange((solution) => update(config.graph_id, solution));

			// Load the default graph
			update(config.graph_id, config.solution)
		});
  </script>
</body>
</html>